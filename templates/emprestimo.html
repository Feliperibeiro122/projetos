{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <title>BIBLIOTECA ESCOLA</title>
</head>
<!-- Direciona para as outras páginas -->
<body>
    <header>
        <a href="{% url 'index' %}" class="painel">Início</a>
        <a href="{% url 'cadastro' %}" class="painel">Cadastro de alunos e professores</a>
        <a href="{% url 'emprestimo' %}" class="painel">Empréstimo e devoluções</a>
    </header>
    <!-- Form para empréstimo -->
    <main class="form-wrapper">
        <h2>Empréstimo e devoluções dos livros</h2>
        <div class="form-container">
        <form method="POST">
            {% csrf_token %}
            <p><label for="id_titulo">Título:</label>
            <input type="text" name="titulo" required id="id_titulo"></p>

            <p><label for="id_descricao">Descrição:</label>
            <input type="text" name="descricao" required id="id_descricao"></p>

            <p><label for="campo-nome">Nome do aluno/professor:</label></p>
            <div class="autocomplete-container">
                <input type="text" name="nome_pessoa" id="campo-nome" autocomplete="off">
                <ul id="nome-alunos"></ul>
            </div>
            <button type="submit" class="button">Emprestar</button>
        </form>
<!-- Histórico de empréstimo -->
        </div>
        <div class="emprestimos-lista">
            <h3>Livros emprestados</h3>
            {% for emprestimo in emprestimos %}
                {% if not emprestimo.devolvido %}
                <p>
                    <strong>{{ emprestimo.titulo }}</strong> para <em>{{ emprestimo.pessoa.nome }}</em> —
                    devolver até <strong>{{ emprestimo.data_devolucao_prevista|date:"d/m/Y" }}</strong> —
                    <a href="{% url 'devolver' emprestimo.id %}" class="devolver-btn">Devolver</a>
                </p>
                {% endif %}
            {% empty %}
                <p>Nenhum empréstimo registrado.</p>
            {% endfor %}

            <h3>Histórico de devoluções</h3>
            {% for emprestimo in emprestimos %}
                {% if emprestimo.devolvido %}
                    <p><strong>{{ emprestimo.titulo }}</strong> devolvido por <em>{{ emprestimo.pessoa.nome }}</em></p>
                {% endif %}
            {% endfor %}
        </div>

    </main>
    <!-- Busca pelo aluno cadastrado e mostra como sugestão -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const campoNome = document.getElementById('campo-nome');
            const sugestoes = document.getElementById('nome-alunos');

            campoNome.addEventListener('input', () => {
                const termo = campoNome.value;
                if (termo.length > 1) {
                    fetch(`/buscar-pessoas/?term=${termo}`, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(res => res.json())
                    .then(data => {
                        sugestoes.innerHTML = '';
                        data.forEach(nome => {
                            const li = document.createElement('li');
                            li.textContent = nome;
                            li.onclick = () => {
                                campoNome.value = nome;
                                sugestoes.innerHTML = '';
                            };
                            sugestoes.appendChild(li);
                        });
                    });
                } else {
                    sugestoes.innerHTML = '';
                }
            });
        });
    </script>
    <footer>&#169 2025 Felipe da silva Ribeiro</footer>
</body>
</html>